!function(t,e){"use strict";e.gui.taxonSelect={hiddenControlsShown:!1,taxonSort:null,width:225,filterMessage:"Filter names (use # for 'starts with')",filterSelectedOnly:"Show only selected taxa",gap:6,textHeightOffset:4,taxonHeight:30,taxonWidth:200},e.gui.taxonSelect.init=function(a,i,s){var n=this;this.isMultiSelect=i,this.hostCallback=s,this.filterText="",this.selectedTaxa=[],this.taxa=[],e.d.taxa.forEach(function(t,e){this.taxa.push({name:t.taxon.kbValue,abbrv:"",order:e})},this);var o=t('<div class="taxonSelect" />').css("width",this.taxonWidth).appendTo(a),r=d3.select(o[0]);this.$div=o;var c=t('<input type="text"/>').addClass("ui-widget ui-widget-content ui-corner-all");c.css("color","silver").css("padding-left",5).css("width",this.taxonWidth-5).css("height",this.taxonHeight),c.val(this.filterMessage),o.append(c),t("<br>").appendTo(o),c.on("keyup",function(){n.setFilter(this.value)}),c.on("focus",function(){this.value!=n.filterMessage&&this.value!=n.filterSelectedOnly||(n.setFilter(""),n.checkFilterColour())}),c.on("blur",function(){n.checkEmptyFilter(),n.checkFilterColour()});var l=t("<div>").css("margin-top",5).css("display","none").appendTo(o),d=t("<img>").attr("src",e.opts.tombiopath+"resources/chevron-down.png").attr("class","taxonSelectHiddenControlsArrow").appendTo(o);d.on("click",function(){n.toggleHiddenControls()});var h=t("<div>").appendTo(l);t("<label>").attr("for","radio-x").text("none").appendTo(h),t("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-x").attr("checked","true").appendTo(h),t("<label>").attr("for","radio-a").text("a-z").appendTo(h),t("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-a").appendTo(h),t("<label>").attr("for","radio-z").text("z-a").appendTo(h),t("<input>").attr("type","radio").attr("name","radioSort").attr("id","radio-z").appendTo(h),h.find("input").checkboxradio(),t("[name=radioSort]").on("change",function(e){n.taxonSort=t("[name='radioSort']").filter(":checked").attr("id"),n.sortTaxa(),n.updateTaxa()}),t("<button>").text("Clear filter").css("margin-top",5).css("width","100%").appendTo(l).button().on("click",function(){n.setFilter(""),n.checkEmptyFilter(),n.checkFilterColour()}),t("<button>").text("Clear selection").css("margin-top",5).css("width","100%").appendTo(l).button().on("click",function(){var t=n.selectedTaxon;n.deselectAllTaxa();var e={selected:n.selectedTaxon,deselected:t,taxa:n.selectedTaxa};n.hostCallback&&n.hostCallback(e)}),t("<button>").text("Show only selected taxa").css("margin-top",5).css("width","100%").appendTo(l).button().on("click",function(){n.setFilter(n.filterSelectedOnly),n.checkFilterColour()}),this.D3svg=r.append("svg"),this.D3svg.attr("width",this.taxonWidth);var x=d3.select("body").append("svg");this.taxa.forEach(function(t){var e=0,a=t.name;do{e>0&&(a=t.name.substr(0,t.name.length-e)+"...");var i=x.append("text").attr("class","taxonSelectScientificnames").style("opacity",0).text(a).node().getBBox().width;e++}while(i>this.taxonWidth-10);a!=t.name&&(t.abbrv=a)},this),x.remove(),this.updateTaxa(),this.$textFilter=c,this.$hiddenControlsDiv=l,this.$controlsArrow=d},e.gui.taxonSelect.setFilter=function(t){this.filterText=t,this.$textFilter.val(t),this.checkFilterColour(),this.updateTaxa()},e.gui.taxonSelect.getFilter=function(){return this.filterText!=this.filterMessage?this.filterText:null},e.gui.taxonSelect.setSort=function(e){"a-z"==e&&(e="radio-a",t("#radio-a").attr("checked","true"),t("[name=radioSort]").checkboxradio("refresh")),"z-a"==e&&(e="radio-z",t("#radio-z").attr("checked","true"),t("[name=radioSort]").checkboxradio("refresh")),"none"==e&&(e="radio-x",t("#radio-x").attr("checked","true"),t("[name=radioSort]").checkboxradio("refresh")),this.taxonSort=e,this.sortTaxa(),this.updateTaxa()},e.gui.taxonSelect.toggleHiddenControls=function(){"none"==this.$hiddenControlsDiv.css("display")?(this.$hiddenControlsDiv.slideDown(400),this.$controlsArrow.attr("src",e.opts.tombiopath+"resources/chevron-up.png"),this.hiddenControlsShown=!0):(this.$hiddenControlsDiv.slideUp(400),this.$controlsArrow.attr("src",e.opts.tombiopath+"resources/chevron-down.png"),this.hiddenControlsShown=!1)},e.gui.taxonSelect.taxonClick=function(t){var e,a=this.D3svg.select('rect[taxonName="'+t+'"]'),i=this.D3svg.select('text[taxonName="'+t+'"]');if(0!=a.size()){var s=a.classed("taxonSelectTaxarectSelected");if(a.classed("taxonSelectTaxarectDeselected",s).classed("taxonSelectTaxarectSelected",!s),i.classed("taxonSelectScientificnamesDeselected",s).classed("taxonSelectScientificnamesSelected",!s),!this.isMultiSelect&&this.selectedTaxon&&this.selectedTaxon!=t){var n=this.D3svg.select('rect[taxonName="'+this.selectedTaxon+'"]'),o=this.D3svg.select('text[taxonName="'+this.selectedTaxon+'"]');n.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),o.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),e=this.selectedTaxon}if(s?(this.selectedTaxon=null,e=t):this.selectedTaxon=t,e){var r=this.selectedTaxa.indexOf(e);-1!=r&&this.selectedTaxa.splice(r,1)}this.selectedTaxon&&this.selectedTaxa.push(this.selectedTaxon);var c={selected:this.selectedTaxon,deselected:e,taxa:this.selectedTaxa};this.hostCallback&&this.hostCallback(c)}else console.log("Couldn't find the taxon:",t)},e.gui.taxonSelect.deselectAllTaxa=function(){var t=this.D3svg.selectAll("rect"),e=this.D3svg.selectAll("text");t.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),e.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),this.selectedTaxon=null,this.selectedTaxa=[],this.updateTaxa()},e.gui.taxonSelect.deselectTaxon=function(t){var e=this.D3svg.select('rect[taxonName="'+t+'"]'),a=this.D3svg.select('text[taxonName="'+t+'"]');e.classed("taxonSelectTaxarectDeselected",!0).classed("taxonSelectTaxarectSelected",!1),a.classed("taxonSelectScientificnamesDeselected",!0).classed("taxonSelectScientificnamesSelected",!1),(this.selectedTaxon=t)&&(this.selectedTaxon=null);var i=this.selectedTaxa.indexOf(t);-1!=i&&this.selectedTaxa.splice(i,1)},e.gui.taxonSelect.setParamsFromState=function(t){if(e=this.getFilter()){if(e.startsWith("#"))var e="-"+e.substr(1);t.push("filter="+e)}if(this.taxonSort){if("radio-a"==this.taxonSort)var a="a-z";else if("radio-z"==this.taxonSort)a="z-a";a&&t.push("sort="+a)}return this.hiddenControlsShown&&t.push("hc=show"),t},e.gui.taxonSelect.initStateFromParams=function(t){if(t.hc&&this.toggleHiddenControls(),t.sort&&this.setSort(t.sort),t.filter){if(t.filter.startsWith("-"))var e="#"+t.filter.substr(1);else e=t.filter;this.setFilter(e)}},e.gui.taxonSelect.sortTaxa=function(){var t=this;this.taxa.sort(function(e,a){var i,s;return"radio-a"==t.taxonSort?(i=e.name.toUpperCase())<(s=a.name.toUpperCase())?-1:i>s?1:0:"radio-z"==t.taxonSort?(i=e.name.toUpperCase())<(s=a.name.toUpperCase())?1:i>s?-1:0:e.order-a.order})},e.gui.taxonSelect.updateTaxa=function(){var a=this,i=this.D3svg.selectAll("g").data(this.taxa.filter(function(t){if(""==this.filterText||this.filterText.toLowerCase()==this.filterMessage.toLowerCase()||"#"==this.filterText)return!0;if(this.filterText.startsWith("#")&&t.name.toLowerCase().startsWith(this.filterText.toLowerCase().substr(1)))return!0;if(-1!==t.name.toLowerCase().indexOf(this.filterText.toLowerCase()))return!0;for(var e=0;e<this.selectedTaxa.length;e++)if(this.selectedTaxa[e]==t.name)return!0;return!1},this),function(t){return t.name}),s=i.enter().append("g"),n=s.merge(i),o=i.exit();s.append("rect").style("opacity",0).attr("x",0).attr("width",this.taxonWidth).attr("height",this.taxonHeight).classed("taxonSelectTaxarect",!0).classed("taxonSelectTaxarectDeselected",!0).attr("taxonName",function(t){return t.name}).on("click",function(t){a.taxonClick(t.name)}),s.append("text").style("opacity",0).attr("x",5).classed("taxonSelectScientificnames",!0).classed("taxonSelectScientificnamesDeselected",!0).classed("abbrvName",function(t){return!!t.abbrv}).attr("taxonName",function(t){return t.name}).text(function(t){return t.abbrv?t.abbrv:t.name}).attr("title",function(t){return t.abbrv?t.name:""}).on("click",function(t){a.taxonClick(t.name)}),n.select(".taxonSelectTaxarect").transition().duration(300).delay(function(){return o.empty()?0:300}).attr("y",function(t,e){return e*(a.taxonHeight+a.gap)+a.gap}).transition().style("opacity",1),n.select(".taxonSelectScientificnames").transition().duration(300).delay(function(){return o.empty()?0:300}).attr("y",function(t,e){return e*(a.taxonHeight+a.gap)+a.taxonHeight/2+a.textHeightOffset+a.gap}).transition().style("opacity",1),o.transition().duration(300).style("opacity",0).remove(),t(".abbrvName").tooltip({classes:{"ui-tooltip":"ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(e,a){setTimeout(function(){t(a.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return t(this).attr("title")}});var r=n._groups[0].length*(this.taxonHeight+this.gap);this.D3svg.transition().delay(function(){return o.empty()?0:300}).attr("height",r).on("end",function(){e.gui.main.resizeControlsAndTaxa()})},e.gui.taxonSelect.checkEmptyFilter=function(){""==this.filterText&&(this.filterText=this.filterMessage,this.$textFilter.val(this.filterMessage))},e.gui.taxonSelect.checkFilterColour=function(){this.filterText==this.filterMessage||this.filterText==this.filterSelectedOnly?this.$textFilter.css("color","silver"):this.$textFilter.css("color","black")}}(jQuery,this.tombiovis);