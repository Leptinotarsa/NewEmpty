!function($,tbv){"use strict";var visName="vis3",vis3=tbv.v.visualisations[visName]=Object.create(tbv.v.visP),_this,taxSel;function addTop(t){var a=[];if(tbv.d.taxa.forEach(function(t){a.push(t)}),tbv.f.sortTaxa(a),a.length>t)var e=a.slice(0,t);else e=a;_this.vis3Taxa=e.map(function(t){return t.taxon.kbValue}),taxSel.deselectAllTaxa(),_this.vis3Taxa.forEach(function(t){taxSel.taxonClick(t)})}function matchFirst(t){var a=[];if($("#visType3Grid").pqGrid("getColModel").forEach(function(t){"group"!=t.dataIndx&&"character"!=t.dataIndx&&a.push(tbv.d.oTaxa[t.dataIndx])}),0!=a.length){var e=a[0];if(t&&(a=tbv.d.taxa),a.forEach(function(t){t.taxon==e.taxon?t.vis3CompScore=999999:(t.vis3CompScore=0,tbv.d.characters.forEach(function(a){"key"==a.Status&&(t.vis3CompScore+=matchingScore(e,t,a))}))}),a.sort(function(t,a){return t.vis3CompScore>a.vis3CompScore?-1:1}),t)var i=a.slice(0,t+1);else i=a;_this.vis3Taxa=i.map(function(t){return t.taxon.kbValue}),taxSel.deselectAllTaxa(),_this.vis3Taxa.forEach(function(t){taxSel.taxonClick(t)})}}function getViewURL(){var t=[];t.push("selectedTool="+visName);for(var a=[],e=$(".pq-grid-title-row").find(".pq-td-div"),i=1;i<e.length;i++)a.push(e[i].children[0].innerText);t.push("taxa="+a.join("^"));var s=[];a.forEach(function(t){void 0!==tbv.d.oTaxa[t].visState[visName].indexSelected?s.push(tbv.d.oTaxa[t].visState[visName].indexSelected):s.push("x")}),t.push("imgs="+s.join("-")),t.push("colwidth="+_this.vis3ColWidth),t=taxSel.setParamsFromState(t),tbv.f.createViewURL(t)}function addRemoveHandler(t,a,e,i){a.on("remove",function(){t.closest(".pq-td-div").css("padding",""),t.closest("td").css("background-color",""),e.fadeIn(),tbv.d.oTaxa[i.taxon.kbValue].visState[visName].imgDiv=null,a.is(".userRemoved")&&(tbv.d.oTaxa[i.taxon.kbValue].visState[visName].displayImages=!1)})}function addTaxonImages(t){var a=t.attr("taxon"),e=tbv.d.oTaxa[a],i=$("<div>");tbv.f.addTaxonImagesToContainer({taxon:a,container:i,indexSelected:tbv.d.oTaxa[a].visState[visName].indexSelected,imageRemovalButton:!0,height:_this.vis3ColWidth,fImageSelect:function(t){tbv.d.oTaxa[a].visState[visName].indexSelected=t}}),tbv.d.oTaxa[a].visState[visName].imgDiv=i,t.closest(".pq-td-div").css("padding",0),t.closest("td").css("background-color","lightgrey"),t.append(i);var s=t.find(".loadImgIcon");return s.fadeOut(0),addRemoveHandler(t,i,s,e),tbv.d.oTaxa[a].visState[visName].displayImages=!0,i}function matchingScore(t,a,e){var i=e.Character,s=null;if("key"==e.Status)if("n/a"==a[i].kbValue||"novalue"==a[i].kbValue||""==a[i].kbValue)"n/a"==t[i].kbValue||"novalue"==t[i].kbValue||""==t[i].kbValue||(s=-1);else if("n/a"==t[i].kbValue||"novalue"==t[i].kbValue||""==t[i].kbValue)s=-1;else if("numeric"==e.ValueType){e.maxVal,e.minVal;var o=tbv.f.score.numberVsRange(a[i].getRange().min,t[i].getRange(),e.Latitude),n=tbv.f.score.numberVsRange(a[i].getRange().max,t[i].getRange(),e.Latitude);s=(o[0]-o[1]+n[0]-n[1])/2}else if("ordinal"==e.ValueType||"ordinalcircular"==e.ValueType){var r,d=0,c=0;["male","female",""].forEach(function(s){a[i].getOrdinalRanges(s).forEach(function(a){r=tbv.f.score.ordinal(a,t[i].getOrdinalRanges(s),e.CharacterStateValues,e.Latitude,"ordinalcircular"==e.ValueType),c+=r[0],c-=r[1],d++})}),s=c/d}else{d=0,c=0;["male","female",""].forEach(function(e){c+=tbv.f.score.jaccard(a[i].getStates(e),t[i].getStates(e)),d++}),s=2*(c/d)-1}return s}vis3.visName=visName,vis3.initialise=function(){_this=this,this.metadata.title="Side by side comparison",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.imageIndex=0,this.helpFiles=[tbv.opts.tombiopath+"vis3/vis3Help.html",tbv.opts.tombiopath+"common/taxon-select-help.html"],tbv.gui.main.contextMenu.addItem("Get URL for side by side comparison view",function(){getViewURL()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Rank those shown against first",function(){matchFirst(),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Show closest two to first",function(){matchFirst(2),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Show closest five to first",function(){matchFirst(5),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Show closest ten to first",function(){matchFirst(10),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Show top two from key",function(){addTop(2),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Show top five from key",function(){addTop(5),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Show top ten from key",function(){addTop(10),_this.refresh()},!1,[this.visName]),tbv.gui.main.contextMenu.addItem("Remove all",function(){_this.vis3Taxa=[],_this.refresh(),taxSel.deselectAllTaxa()},!1,[this.visName]),_this.vis3Taxa=[];var t=$("<div/>").css("position","relative").css("top",-13);$(this.cssSel).append(t),(taxSel=Object.create(tbv.gui.taxonSelect)).init(tbv.gui.main.divInput,!0,function(t){t.selected&&-1==_this.vis3Taxa.indexOf(t.selected)&&(_this.vis3Taxa.push(t.selected),_this.refresh()),t.deselected&&-1!=_this.vis3Taxa.indexOf(t.deselected)&&(_this.vis3Taxa.splice(_this.vis3Taxa.indexOf(t.deselected),1),_this.refresh()),0==t.taxa.length&&(_this.vis3Taxa=[],_this.refresh())}),t.append($("<div>").css("display","inline-block").css("width",150).css("height",1));var a=$("<div id='visType3Grid'></div>");t.append(a),this.taxonSelect=taxSel,this.initialised=!0,tbv.f.checkInterface(visName,tbv.templates.visTemplate,tbv.v.visualisations[visName])},vis3.refresh=function(){$("#visType3Grid").is(":empty")||$("#visType3Grid").pqGrid("destroy");var t=[],a={group:" Images",character:"Images"};this.vis3Taxa.forEach(function(t){var e=tbv.d.oTaxa[t],i=$("<div>").attr("taxon",t).css("position","relative").attr("class","vis3ImageDiv");a[e.taxon]=i[0].outerHTML}),t.push(a),tbv.d.characters.forEach(function(a){if("display"==a.Status||"key"==a.Status&&"Sex"!=a.Character){var e={group:a.Group,character:a.Label,pq_cellcls:{character:a.Character}};_this.vis3Taxa.forEach(function(t){var i=tbv.d.oTaxa[t];e[i.taxon]=i[a.Character].toHtml1()}),t.push(e)}});var e=[];["group"].concat(["character"].concat(this.vis3Taxa)).forEach(function(t,a){if(0==a)var i=!0;else i=!1;if(1==a)var s="Character";else s="<i>"+t+"</i>";if(_this.vis3ColWidth||(_this.vis3ColWidth=200),_this.vis3CharColWidth||(_this.vis3CharColWidth=200),1==a)var o=_this.vis3CharColWidth;else o=_this.vis3ColWidth;var n={title:s,hidden:i,width:o,dataType:"string",dataIndx:t,sortable:!1};e.push(n)});var i=null;"visible"==$("input[name=groupvisibility]:checked").val()&&(i={dataIndx:["group"],collapsed:[!0],title:["<b style='font-weight:bold;'>{0}</b>","{0}"],dir:["up","down"]});var s={flexHeight:!0,flexWidth:!0,showTop:!1,showBottom:!1,showTitle:!1,numberCell:{show:!1},stripeRows:!0,columnBorders:!0,showHeader:!0,editable:!1,resizable:!1,groupModel:i,selectionModel:{type:null,mode:null},columnResize:function(t,a){!function(t){if("character"==t.dataIndx)return void(_this.vis3CharColWidth=t.newWidth);console.log(t.newWidth),_this.vis3ColWidth=t.newWidth,o()}(a)},refresh:function(){!function(){$(".vis3ImageDiv").each(function(){var t=$(this),a=$(this).attr("taxon"),e=tbv.d.oTaxa[a];if(tbv.f.getTaxonImages(a).length>0){var i=$("<img>").attr("src",tbv.opts.tombiopath+"resources/camera.png").addClass("loadImgIcon").css("cursor","pointer").css("width",15).on("click",function(){var a=$(this),i=addTaxonImages(t);addRemoveHandler(t,i,a,e)});$(this).append(i),tbv.d.oTaxa[a].visState[visName].displayImages&&addTaxonImages(t)}});var t=d3.scaleLinear().domain([-1,0,1]).range(tbv.d.scoreColours),a=[];if($("#visType3Grid").pqGrid("getColModel").forEach(function(t){"group"!=t.dataIndx&&"character"!=t.dataIndx&&a.push(t.dataIndx)}),a.length<2)return;a.forEach(function(t,a){$("td[pq-row-indx=0][pq-col-indx="+(a+2)+"]").css("background-color","rgb(100,100,100)").css("color","white")});for(var e=tbv.d.oTaxa[a[0]],i=1;i<a.length;i++){var s=tbv.d.oTaxa[a[i]];for(var o in tbv.d.oCharacters){var n=tbv.d.oCharacters[o],r=$("."+n.Character).closest("tr").attr("pq-row-indx");if(null!=r){if(1==i){var d=$("#visType3Grid").pqGrid("getCell",{rowIndx:r,dataIndx:a[0]});"key"==n.Status?"n/a"==e[o].kbValue||"novalue"==e[o].kbValue||""==e[o].kbValue||"?"==e[o].kbValue?d.css("background-color","white"):d.css("background-color",t(1)):"display"==n.Status&&d.css("background-color","lightgrey")}var c=$("#visType3Grid").pqGrid("getCell",{rowIndx:r,dataIndx:a[i]}),l=matchingScore(e,s,n);"display"==n.Status?c.css("background-color","lightgrey"):null==l?c.css("background-color","white"):c.css("background-color",t(l))}}}}()}};function o(){$("#visType3Grid").pqGrid("getColModel").forEach(function(t){"group"!=t.dataIndx&&"character"!=t.dataIndx&&(t.width=_this.vis3ColWidth)}),$("#visType3Grid").pqGrid("refresh")}s.colModel=e,s.dataModel={data:t,location:"local"},$("#visType3Grid").pqGrid(s),o()},vis3.urlParams=function(t){_this.vis3ColWidth=t.colwidth,t.taxa&&t.taxa.split("^").forEach(function(t){taxSel.taxonClick(t.replace(/%20/g," "))}),t.imgs&&t.imgs.split("-").forEach(function(t,a){var e=_this.vis3Taxa[a];if("x"!=t){tbv.d.oTaxa[e].visState[visName].indexSelected=t;var i=$('.vis3ImageDiv[taxon="'+e+'"]'),s=i.find(".loadImgIcon");addRemoveHandler(i,addTaxonImages(i),s,e)}}),setTimeout(function(){taxSel.initStateFromParams(t)},100)},vis3.show=function(){if($("#vis3").show(),taxSel.$div.show(),tbv.opts.toolconfig.vis3.init)try{eval(tbv.opts.toolconfig.vis3.init)}catch{console.log(tbv.opts.toolconfig.vis3.init,"not a valid function call.")}},vis3.hide=function(){$("#vis3").hide(),taxSel.$div.hide()}}(jQuery,this.tombiovis);