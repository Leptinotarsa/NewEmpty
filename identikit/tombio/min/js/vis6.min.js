!function(t,i){"use strict";var e=i.v.visualisations.vis6=Object.create(i.v.visP);e.visName="vis6",e.fn={};var a="all",s=!0;function n(t,i){var e=Math.pow(10,i||0);return Math.round(t*e)/e}function o(t,i,e){var a=t[i.Character].score.overall;return e&&(a=a*i.Weight/10),n(a,1)}function r(t){if((t=(Math.round(10*t)/10).toFixed(1))<0)var i="";else if(t>0)i="+";else i=" ";return i+t}e.initialise=function(){this.metadata.title="Mobile key",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.helpFiles=[i.opts.tombiopath+"vis6/vis6Help.html"];var a=i.opts.toolconfig[this.visName].keyinput;i.gui.sharedKeyInput[a]||(i.gui.sharedKeyInput[a]=Object.create(i.gui[a]),i.gui.sharedKeyInput[a].init(t(i.gui.main.divInput))),e.inputControl=i.gui.sharedKeyInput[a];t("#"+this.visName).html('<ons-page id="tombioVis6page"><ons-toolbar modifier="noshadow"><div class="center"><ons-segment id="tombioVis6segment" style="width: calc(100% - 10px); margin: 0 5px 0 5px"><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'all\')"><div class="vis6ellipsis">All</div></button><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'matched\')"><div class="vis6ellipsis">Matched</div></button><button onclick="tombiovis.v.visualisations.vis6.fn.setVisType(\'discounted\')"><div class="vis6ellipsis">Discounted</div></button></ons-segment></div></ons-toolbar><div id="tombioVis6Main" style="position:relative"></ons-page><div>'),document.addEventListener("show",function(t){"tombioVis6page"==t.target.id&&e.refresh()}),this.initialised=!0,i.f.checkInterface("vis6",i.templates.visTemplate,i.v.visualisations.vis6)},e.refresh=function(){var o=[];i.d.taxa.forEach(function(t){("all"==a||"matched"==a&&t.visState.score.charFor==t.visState.score.charUsed||"discounted"==a&&t.visState.score.charFor!=t.visState.score.charUsed)&&o.push(t)}),"all"==a?i.f.sortTaxa(o,"all"):i.f.sortTaxa(o,"matched");for(var l=d3.select("#tombioVis6Main").selectAll(".taxon").data(o,function(t){return t.taxon}),d=l.enter(),c=l.exit(),u=d.append("div").attr("class","taxon").style("overflow","hidden").attr("id",function(t){return"vis6 "+t.taxon}).style("padding","5px").style("left","5px").style("opacity","0").style("width","calc(100% - 20px)").html(function(t){var i="";return i+='<table class="vis6TaxonInfo">',i+="<tr>",i+='<td class="vis6TaxonLeft">',i+="<div class='vis6ellipsis' onclick='tombiovis.gui.main.showFullDetails(\""+t.taxon+"\", 0)'>"+t.taxon+"</div>",i+="</td>",i+='<td class="vis6TaxonRight">',i+='<span class="vis6CharInd" data-taxon="'+t.taxon+'">0</span>&nbsp;<span class="vis6ScoreInd" data-taxon="'+t.taxon+'"></span>',i+='<ons-icon style="margin-left: 5px" icon="md-help" onclick="tombiovis.v.visualisations.vis6.fn.showScoreDetails(\''+t.taxon+"')\"></ons-icon>",i+="</td>",i+="</tr>",i+="</table>"}).merge(l),v=0,h=0;h<o.length;h++){var p=document.getElementById("vis6 "+o[h].taxon.kbValue),f=t(p).find(".vis6TaxonRight");f.show(),p.scrollWidth>t(p).innerWidth()&&f.hide(),o[h].visState.vis6.y=v+10,o[h].visState.vis6.height=p.offsetHeight,v=o[h].visState.vis6.y+o[h].visState.vis6.height}u.transition().duration(1e3).style("opacity","1").style("top",function(t,i){return t.visState.vis6.y+"px"}),c.transition().duration(1e3).style("opacity",function(){return 0}).transition().remove();var m=d3.max(i.d.taxa,function(t){return t.visState.score.overall}),b=d3.min(i.d.taxa,function(t){return t.visState.score.overall}),g=d3.scaleLinear().domain([b,0,m]).range(i.d.scoreColours),x=i.d.characters.map(function(t){return t.stateSet?1:0}).reduce(function(t,i){return t+i}),y=d3.scaleLinear().domain([0,x/2,x]).range(i.d.scoreColours);u.selectAll(".vis6ScoreInd").text(function(){return r(n(i.d.oTaxa[this.getAttribute("data-taxon")].visState.score.overall,1))}).transition().duration(1e3).style("background-color",function(){return g(i.d.oTaxa[this.getAttribute("data-taxon")].visState.score.overall,1)}),u.selectAll(".vis6CharInd").text(function(){return n(i.d.oTaxa[this.getAttribute("data-taxon")].visState.score.charFor,1)}).transition().duration(1e3).style("background-color",function(){return y(i.d.oTaxa[this.getAttribute("data-taxon")].visState.score.charFor)}),"guiOnsenUi"!=i.opts.gui&&d3.select("#vis6").transition().duration(1e3).style("height",v+20+"px"),s&&(s=!1,setTimeout(e.refresh,1e3))},e.urlParams=function(t){},e.show=function(){t("#vis6").show(),t(e.inputControl.divSel).show(),e.inputControl.initFromCharacterState()},e.hide=function(){t("#vis6").hide(),t(e.inputControl.divSel).hide()},e.fn.setVisType=function(t){a=t,e.refresh()},e.fn.showScoreDetails=function(t){var e=i.d.oTaxa[t],a="";a+='<div style="font-style: italic; font-size: 1.2em">'+t+"</div>",a+='<div style="margin: 1em 0">',a+="Matching characters: <b>"+e.visState.score.charFor+" from "+e.visState.score.charUsed+"</b><br/>",a+="Overall matching score: <b>"+n(e.visState.score.overall,1)+"</b><br/>",a+="</div>",a+="<ons-list>",i.d.characters.forEach(function(t){if(t.userInput){var s=d3.max(i.d.taxa,function(i){return i[t.Character].score.overall}),n=d3.min(i.d.taxa,function(i){return i[t.Character].score.overall}),l=d3.scaleLinear().domain([n,0,s]).range(i.d.scoreColours);a+="<ons-list-item expandable tappable>",a+='<div class="middle">'+t.Label+"</div>",a+='<div class="left" ><span class="vis6CharWeightedScore" style="background-color: '+l(o(e,t,!0))+'">'+r(o(e,t,!0))+"</span></div>",a+='<div class="expandable-content">',a+="<table>",a+="<tr>",a+='<td style="white-space: nowrap">Input states:</td>',a+="<td>"+function(t){if("text"==t.ValueType||"ordinal"==t.ValueType||"ordinalcircular"==t.ValueType){var i="";t.userInput.forEach(function(e){i&&(i+=" <i>or</i> "),i+='<span style="font-weight: bold">'+t.CharacterStateValues[e]+"</span>"})}else if("numeric"==t.ValueType)var i='<span style="font-weight: bold">'+t.userInput+"</span>";return i}(t)+"</td>",a+="</tr>",a+="<tr>",a+='<td style="white-space: nowrap">Taxon states:</td>',a+="<td>"+e[t.Character].toHtml2(!0)+"</td>",a+="</tr>",a+="<tr>",a+="<td>Match:</td>",a+="<td><b>"+(o(e,t,!0)>0?"yes":"no")+"</b></td>",a+="</tr>",a+="<tr>",a+="<td>Weighted:</td>",a+="<td><b>"+r(o(e,t,!0))+"</b></td>",a+="</tr>",a+="<td>Unweighted:</td>",a+="<td><b>"+r(o(e,t,!1))+"</b></td>",a+="</tr>",a+="</table>",a+="</div>",a+="</ons-list-item>"}}),a+="</ons-list>",i.gui.main.dialog("Taxon score breakdown",a)}}(jQuery,this.tombiovis);