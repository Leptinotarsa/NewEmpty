!function(t,i){"use strict";var e,a="vis1",s=i.v.visualisations[a]=Object.create(i.v.visP);function n(t,a){var s=i.f.getTaxonImages(t.taxon);if(s.length>0){var n=new Image;n.onload=function(){d3.select("#vis1Svg").select("#taxon-"+a).select(".taxonimage").attr("xlink:href",this.src).style("z-index",1e3).attr("height",(e.taxwidth-2*e.margin)*n.height/n.width),t.visState.vis1.height=(e.taxwidth-2*e.margin)*n.height/n.width+e.indVoffset+e.margin,e.refresh()},n.src=s[0].URI}}s.visName=a,s.initialise=function(){e=this,this.metadata.title="Two-column key",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.displayToolTips=!0,this.taxheight=35,this.indVoffset=18,this.helpFiles=[i.opts.tombiopath+"vis1/vis1Help.html",i.opts.tombiopath+"common/taxonDetailsHelp.html",i.opts.tombiopath+"common/full-details.html",i.opts.tombiopath+"common/stateInputHelp.html"],this.taxwidth=220,this.margin=4,t("#"+this.visName).append(t("<div>").attr("id","headerTaxa").append(t("<span>").attr("id","candidateTaxa").css("position","absolute").css("width",this.taxwidth).css("left",this.margin).css("font-size","small").text("Evidence balance positive")).append(t("<span>").attr("id","excludedTaxa").css("position","absolute").css("width",this.taxwidth).css("left",this.taxwidth+2*this.margin).css("font-size","small").text("Evidence balance negative"))),d3.select("#"+this.visName).append("svg").attr("id","vis1Svg");var n=i.opts.toolconfig[this.visName].keyinput;i.gui.sharedKeyInput[n]||(i.gui.sharedKeyInput[n]=Object.create(i.gui[n]),i.gui.sharedKeyInput[n].init(t(i.gui.main.divInput))),s.inputControl=i.gui.sharedKeyInput[n],this.initialised=!0,i.f.checkInterface(a,i.templates.visTemplate,i.v.visualisations[a])},s.refresh=function(){var s=this.margin,o=this.indVoffset,r=this.taxwidth,l=this.taxheight;t("#vis1Svg").css("width",15+2*r),t("#candidateTaxa").css("left",5),t("#excludedTaxa").css("left",10+r);var c=d3.select("#vis1Svg").selectAll(".taxon").data(i.d.taxa,function(t,i){return t.taxon}).enter().append("g").attr("class","taxon").attr("id",function(t,i){return"taxon-"+i}).style("cursor","pointer").on("click",function(t,i){t.visState.vis1.height==l?n(t,i):(t.visState.vis1.height=l,e.refresh())});c.append("rect").attr("x",0).attr("y",0).attr("class","taxarect").attr("height",l).attr("width",r),c.append("text").attr("x",0).attr("y",0).attr("class","scientificnames").style("opacity",0).style("cursor","pointer").text(function(t){return t.taxon}).on("click",function(t){d3.event.stopPropagation(),i.gui.main.showFullDetails(t.taxon,0)}),i.gui.main.createTaxonToolTips(".scientificnames",this.displayToolTips),c.append("svg:image").attr("class","taxonimage").attr("opacity",0).attr("width",r-2*s);for(var h=1;h<=1;h++)c.append("rect").attr("class","indicator").attr("x",0).attr("y",0).attr("width",0).attr("height",0);for(h=1;h<=1;h++)c.append("text").attr("class","indtext").attr("x",0).attr("y",0);i.d.taxa.forEach(function(t){null==t.visState.vis1.height&&(t.visState.vis1.height=l)});var u=d3.select("#vis1Svg").selectAll(".taxon"),v=[],d=[];i.d.taxa.forEach(function(t){t.visState.score.for>t.visState.score.against?v.push(t):d.push(t)}),i.f.sortTaxa(v,"vis1"),i.f.sortTaxa(d,"vis1");var m=0;for(h=0;h<v.length;h++)v[h].visState.vis1.x=5,v[h].visState.vis1.y=m+5,m=v[h].visState.vis1.y+v[h].visState.vis1.height;m=0;for(h=0;h<d.length;h++)d[h].visState.vis1.x=r+10,d[h].visState.vis1.y=m+5,m=d[h].visState.vis1.y+d[h].visState.vis1.height;u.select(".taxarect").transition().duration(1e3).delay(250).attr("x",function(t){return t.visState.vis1.x}).attr("y",function(t){return t.visState.vis1.y}).attr("height",function(t){return t.visState.vis1.height}),u.select(".scientificnames").transition().duration(1e3).delay(250).style("opacity",1).attr("x",function(t){return t.visState.vis1.x+5}).attr("y",function(t,i){return t.visState.vis1.y+13});var g=d3.max(i.d.taxa,function(t){return t.visState.score.for}),x=d3.max(i.d.taxa,function(t){return t.visState.score.against}),f=d3.max(i.d.taxa,function(t){return t.visState.score.overall}),p=d3.min(i.d.taxa,function(t){return t.visState.score.overall}),y=d3.scaleLinear().domain([p,0,f]).range(i.d.scoreColours),S=d3.scaleLinear().domain([0,g]).range(i.d.scoreColours.slice(1)),T=d3.scaleLinear().domain([0,x]).range(i.d.scoreColours.slice(0,1).reverse()),w=(d3.scaleLinear().domain([0,10]).range(i.d.scoreColours.slice(1)),[{scale:y,attr:"overall"},{scale:S,attr:"for"},{scale:T,attr:"against"}]),I=["overall","for","against"],b=["overall score","score for","score against"];u.selectAll(".indicator").transition().duration(1e3).delay(250).attr("fill",function(t,i,e){return w[i].scale(t.visState.score[w[i].attr])}).attr("x",function(t,i,e){var a=t.visState.vis1.x+s+i*(s+30);return t.visState.vis1.height==l?a:a+s}).attr("y",function(t,i,e){var a=t.visState.vis1.y+o;return t.visState.vis1.height==l?a:a+s}).attr("width",30).attr("height",12).attr("title",function(t,i,e){return Math.round(100*t.visState.score[I[i]])/100+" ("+b[i]+")"}),u.selectAll(".indtext").transition().duration(1e3).delay(250).text(function(t,i,e){return Math.round(100*t.visState.score[I[i]])/100}).attr("x",function(t,i,e){var a=t.visState.vis1.x+s+2+i*(s+30);return t.visState.vis1.height==l?a:a+s}).attr("y",function(t,i,e){var a=t.visState.vis1.y+o+10;return t.visState.vis1.height==l?a:a+s}),u.selectAll(".taxonImageLink").transition().duration(1e3).delay(250).attr("x",function(t){return t.visState.vis1.x+r-2*s-16}).attr("y",function(t,i,e){return t.visState.vis1.y+o+s}).style("opacity",function(t,e){return t.visState.vis1.height!=l&&i.d.media.filter(function(i){if(i.taxon==t.taxon)return!0}).length>0?1:0}).on("end",function(t,i){0==d3.select(this).style("opacity")?d3.select(this).attr("display","none"):d3.select(this).attr("display","")}),u.select(".taxonimage").transition().duration(1e3).delay(250).attr("opacity",function(t,i){return t.visState.vis1.height==l?0:1}).attr("x",function(t){return t.visState.vis1.x+s}).attr("y",function(t){return t.visState.vis1.y+o}).attr("width",r-2*s).on("end",function(t,i){t.visState.vis1.height==l&&d3.select(this).attr("height",0)}),d3.select("#vis1Svg").transition().duration(1e3).delay(250).attr("height",function(){if(0==d.length)var t=0;else t=d[d.length-1].visState.vis1.y+d[d.length-1].visState.vis1.height;if(0==v.length)var i=0;else i=v[v.length-1].visState.vis1.y+v[v.length-1].visState.vis1.height;return Math.max(i,t)}),i.gui.main.contextMenu.addItem("Get URL for two-column key",function(){!function(){var t=[];t.push("selectedTool="+a),Array.prototype.push.apply(t,i.f.setParamsFromControls()),t.push("imgtips="+e.displayToolTips);var s,n=null,o=[];i.d.taxa.forEach(function(t,i){t.visState.vis1.height>e.taxheight&&(null===n?(n=i,s=i):i===s+1?s=i:(s===n?o.push(n):o.push(n+"-"+s),n=i,s=i))}),null!=n&&(s===n?o.push(n):o.push(n+"-"+s));t.push("expand="+o.join(",")),i.f.createViewURL(t)}()},!1,[this.visName]),this.displayToolTips?(i.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){t(".ui-tootip").remove(),e.displayToolTips=!1,i.gui.main.contextMenu.removeItem("Remove taxon image tooltips"),e.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),i.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(i.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){e.displayToolTips=!0,i.gui.main.contextMenu.removeItem("Display taxon image tooltips"),e.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),i.gui.main.contextMenu.removeItem("Remove taxon image tooltips")),i.d.taxa.some(function(t){return t.visState.vis1.height!=l})?i.gui.main.contextMenu.addItem("Contract all taxon items",function(){i.d.taxa.forEach(function(t){t.visState.vis1.height=l}),i.gui.main.contextMenu.removeItem("Contract all taxon items"),e.refresh()},!1,[this.visName]):i.gui.main.contextMenu.removeItem("Contract all taxon items"),i.d.taxa.some(function(t){return t.visState.vis1.height==l&&i.f.getTaxonImages(t.taxon).length>0})?i.gui.main.contextMenu.addItem("Expand all taxon items",function(){i.d.taxa.forEach(function(t,a){var n=i.f.getTaxonImages(t.taxon);if(t.visState.vis1.height==l&&n.length>0){var c=new Image;c.onload=function(){d3.select("#vis1Svg").select("#taxon-"+a).select(".taxonimage").attr("xlink:href",this.src).attr("height",(r-2*s)*c.height/c.width),t.visState.vis1.height=(r-2*s)*c.height/c.width+o+s,e.refresh()},c.src=n[0].URI}}),i.gui.main.contextMenu.removeItem("Expand all taxon items")},!1,[this.visName]):i.gui.main.contextMenu.removeItem("Expand all taxon items")},s.urlParams=function(t){t.imgtips&&(e.displayToolTips="true"===t.imgtips),t.expand&&t.expand.split(",").forEach(function(t){var e=t.split("-")[0],a=t.split("-")[1];if(a)for(var s=Number(e);s<=Number(a);s++)n(i.d.taxa[s],s);else n(i.d.taxa[e],e)}),i.f.initControlsFromParams(t)},s.show=function(){t("#vis1").show(),t(s.inputControl.divSel).show(),s.inputControl.initFromCharacterState()},s.hide=function(){t("#vis1").hide(),t(s.inputControl.divSel).hide()}}(jQuery,this.tombiovis);