!function(t,a){"use strict";var e,n="vis5",r=a.v.visualisations[n]=Object.create(a.v.visP);r.visName=n;var i,o,s,l,u,d,c,p,m,h,f,v,x,g,y,b,k,I,M=1,T=0,w=0,C=/Mobi/.test(navigator.userAgent);function S(t){o=t,d3.transition().duration(750).tween("zoom",function(){var t=d3.interpolateZoom(p,[o.x,o.y,2*o.r+h]);return function(a){A(t(a),[o.x,o.y,2*o.r+h],null,!0)}})}function A(e,r,i,o){"visPjQueryUILargeFormat"==a.opts.toolconfig[n].prototype&&t(".node-taxa").tooltip("close");var s=m/e[2];p=e,i?y.selectAll("circle,text").transition(i).attr("transform",function(t){return"translate("+(t.x-e[0])*s+","+(t.y-e[1])*s+")"}).attr("r",function(t){return t.r*s}):y.selectAll("circle,text").attr("transform",function(t){return"translate("+(t.x-e[0])*s+","+(t.y-e[1])*s+")"}).attr("r",function(t){return t.r*s}),Math.round(100*e[0])/100==Math.round(100*r[0])/100&&Math.round(100*e[1])/100==Math.round(100*r[1])/100&&Math.round(100*e[2])/100==Math.round(100*r[2])/100&&o&&L(i)}function L(t){t?y.selectAll("text").transition(t).on("end",function(t){F(d3.select(this),t)}):y.selectAll("text").each(function(t){F(d3.select(this),t)})}function R(){var t,a;if(I=!0,d3.event.transform.k>M?t=120:d3.event.transform.k<M&&(t=-120),t){a=t>0?100/t:Math.abs(t/100);var e=0,n=0}else{a=1;e=(d3.event.transform.x-T)*(p[2]/m),n=(d3.event.transform.y-w)*(p[2]/m)}var r=[p[0]-e,p[1]-n,p[2]*a];k=1==a,M=d3.event.transform.k,T=d3.event.transform.x,w=d3.event.transform.y,C||A(r,r,null,!1)}function N(){I&&(k||L(null)),I=!1}function j(t,a,e){var n=t.split(/\s+/).reverse();if(n.length>1){if(1==a)return n.pop().substring(0,1)+". "+n.reverse().join(" ");if(2==a){for(var r=n.pop().substr(0,1)+".";i=n.pop();)r+=" "+i.substr(0,3),i.length>3&&(r+=".");return r}var i;for(r="";i=n.pop();)r+=i.substr(0,1);return r}return 1==a?t.length>5?t.substr(0,5)+".":t:2==a?t.length>3?t.substr(0,3)+".":t:t.substr(0,1)+"."}function E(t){e.selectedRank=t,d3.selectAll(".label").style("display","none"),d3.selectAll("text."+t).style("display","inline"),d3.selectAll("circle").style("stroke-width","0px"),d3.selectAll("circle."+t).style("stroke","black").style("stroke-width","1px")}function F(t,a){if("none"!=t.style("display")){var n=d3.select("#"+t.attr("circleId")).node().getBBox().width;if(e.abbrvnames)if(n<20&&e.abbrvnames)t.text(null);else{var r=[80,55,30],i=-1;r.forEach(function(t,a){-1==i&&n>t&&(i=a)}),-1==i&&(i=r.length),P(t,n,a.data.data.abbrv[i])}else P(t,n,a.data.data.abbrv[0])}}function P(t,a,e){for(var n,r=e.split(/\s+/).reverse(),i=[],o=1,s=t.attr("y"),l=t.text(null).append("tspan").attr("class","tspan").attr("x",0).attr("y",s);n=r.pop();)i.push(n),l.text(i.join(" ")),l.node().getComputedTextLength()>a&&(i.pop(),i.length>0?l.text(i.join(" ")):(l.remove(),o--),i=[n],l=t.append("tspan").attr("class","tspan").attr("x",0).attr("y",s).text(n),++o>1&&l.attr("dy","1em"));t.attr("dy",(1.5-o)/2+"em")}r.initialise=function(){e=this,this.metadata.title="Circle-pack key",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.abbrvnames=!0,this.displayToolTips=!1,this.helpFiles=[a.opts.tombiopath+"vis5/vis5Help.html",a.opts.tombiopath+"common/taxonDetailsHelp.html",a.opts.tombiopath+"common/full-details.html",a.opts.tombiopath+"common/stateInputHelp.html"],(s=d3.select("#"+this.visName).append("svg").attr("id","vis5Svg").attr("width","500").attr("height","500").attr("overflow","visible").call(d3.zoom().on("zoom",R).on("end",t.proxy(N,e)))).on("click",function(){S(i)}),h=20,m=+s.attr("width"),y=s.append("g").attr("transform","translate("+m/2+","+m/2+")"),b=d3.scaleLinear().domain([-1,5]).range(["hsl(152,0%,80%)","hsl(228,0%,40%)"]).interpolate(d3.interpolateHcl),l=d3.pack().size([m-h,m-h]).padding(2),f=[],a.d.characters.forEach(function(t){"taxonomy"!=t.Group.toLowerCase()&&"taxon"!=t.Character||f.push(t.Character)});var o=[{name:"All taxa",parent:""}];f.forEach(function(t,e){a.d.taxa.forEach(function(n,r){var i=n[t].kbValue;if(""!=i&&!function(t,a){for(var e=0;e<t.length;e++)if(t[e].name==a)return!0;return!1}(o,i)){for(var s="",l=e-1;l>-1&&""==(s=n[f[l]].kbValue);l-=1);""==s&&(s="All taxa"),o.push({name:i,parent:s,rankColumn:t,rank:a.d.oCharacters[t].Label,abbrv:[i,j(i,1,"taxon"==t),j(i,2,"taxon"==t),j(i,3,"taxon"==t)],taxon:"taxon"==t?n:null})}})}),v=d3.stratify().id(function(t){return t.name}).parentId(function(t){return t.parent})(o);var u=(x=d3.stratify().id(function(t){return t.name}).parentId(function(t){return""==t.parent?"":"All taxa"})(o)).children.filter(function(t){return"taxon"==t.data.rankColumn});x.children=u,g=v;var d=a.opts.toolconfig[this.visName].keyinput;a.gui.sharedKeyInput[d]||(a.gui.sharedKeyInput[d]=Object.create(a.gui[d]),a.gui.sharedKeyInput[d].init(t(a.gui.main.divInput))),r.inputControl=a.gui.sharedKeyInput[d],this.initialised=!0,a.f.checkInterface(n,a.templates.visTemplate,a.v.visualisations[n])},r.refresh=function(){e=this;var r=d3.max(a.d.taxa,function(t){return t.visState.score.overall}),s=d3.min(a.d.taxa,function(t){return t.visState.score.overall});a.gui.main.contextMenu.addItem("Get URL for circle-pack key",function(){!function(){var t=[];t.push("selectedTool="+n),Array.prototype.push.apply(t,a.f.setParamsFromControls()),t.push("abbrvnames="+e.abbrvnames),t.push("rank="+e.selectedRank),g==x&&t.push("highertaxa=false");t.push("imgtips="+e.displayToolTips),a.f.createViewURL(t)}()},!1,[e.visName]),a.gui.main.contextMenu.addItem("Toggle name abbreviation",function(){e.abbrvnames=!e.abbrvnames,e.refresh()},!1,[e.visName]),f.length>1&&g==v?(a.gui.main.contextMenu.addItem("Ignore higher taxa",function(){g=x,E("taxon"),e.refresh()},!1,[e.visName]),f.forEach(function(t){a.gui.main.contextMenu.addItem("Show names for each "+a.d.oCharacters[t].Label,function(){E(t),e.refresh()},!1,[e.visName])}),a.gui.main.contextMenu.removeItem("Show higher taxa")):f.length>1&&g==x&&(a.gui.main.contextMenu.addItem("Show higher taxa",function(){g=v,E("taxon"),e.refresh()},!1,[e.visName]),f.forEach(function(t){a.gui.main.contextMenu.removeItem("Show names for each "+a.d.oCharacters[t].Label)}),a.gui.main.contextMenu.removeItem("Ignore higher taxa")),this.displayToolTips?(a.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){e.displayToolTips=!1,a.gui.main.contextMenu.removeItem("Remove taxon image tooltips"),e.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),a.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(a.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){e.displayToolTips=!0,a.gui.main.contextMenu.removeItem("Display taxon image tooltips"),e.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),a.gui.main.contextMenu.removeItem("Remove taxon image tooltips"));var m=d3.scaleLinear().domain([s,0,r]).range(a.d.scoreColours),k=s<0?0-s:0;i=d3.hierarchy(g).sum(function(t){return t.data.taxon?Math.pow(t.data.taxon.visState.score.overall+k+.1,1.5):0}).sort(function(t,a){return a.value-t.value}),o=i;var I=l(i).descendants();u=y.selectAll("circle").data(I,function(t){return t.data.id}),d=u.enter().append("circle").attr("class",function(t){var a=t.children?"node-taxa node-higher-taxa":"node-taxa";return a+=" "+t.data.data.rankColumn}).attr("id",function(t){return a.f.taxonTag(t.data.id)}).on("click",function(t){o!==t&&(d3.event.stopPropagation(),S(t))}),(c=d.merge(u)).attr("title",function(t){return t.children?t.data.data.rank?t.data.id+" ("+t.data.data.rank+")":t.data.id:C(t)}),g==v&&f.length>1?t(".node-higher-taxa").css("visibility","visible"):t(".node-higher-taxa").css("visibility","hidden");var M=d3.transition().duration(750);c.transition(M).style("fill",function(t){return t.children?b(t.depth):t.data.data.taxon?m(t.data.data.taxon.visState.score.overall):0});var T=y.selectAll("text").data(I,function(t){return t.data.id}),w=T.enter().append("text").text(function(t){return t.data.id}).style("background-color","red").attr("taxonName",function(t){return t.data.id}).attr("class",function(t){return"label "+t.data.data.rankColumn}).attr("circleId",function(t){return a.f.taxonTag(t.data.id)}).style("display","none").on("click",function(t){t.data.data.taxon&&(d3.event.stopPropagation(),a.gui.main.showFullDetails(t.data.data.taxon.taxon,0))});function C(t){var n;if(n=t.data.data.taxon?"<i>"+t.data.id+"</i> <span style='background-color: "+m(t.data.data.taxon.visState.score.overall)+"; padding: 2px 5px 2px 5px; margin-left: 5px'>"+Math.round(100*t.data.data.taxon.visState.score.overall)/100+"</span>":"<i>"+t.data.id+"</i>",e.displayToolTips){var r=a.f.getTaxonTipImage(t.data.id);r&&(r.css("margin-top",5),n+=r[0].outerHTML)}return n}w.merge(T).attr("title",function(t){return t.children?t.data.id:C(t)}),T.exit().remove(),"guiLargeJqueryUi"==a.opts.gui&&t("circle, text").tooltip({classes:{"ui-tooltip":"taxon-tooltip ui-corner-all ui-widget-shadow"},track:!0,position:{my:"left+20 center",at:"right center"},open:function(a,e){setTimeout(function(){t(e.tooltip).hide({effect:"fade",duration:500})},3e3)},content:function(){return t(this).attr("title")}}),p?A(p,p,M,!0):(A([i.x,i.y,2*i.r+h],[i.x,i.y,2*i.r+h],M,!0),E("taxon")),function(t){var n=d3.max(a.d.taxa,function(t){return t.visState.score.overall});c.transition(t).filter(function(t){return t.data.data.taxon}).style("stroke",function(t){return n>0&&t.data.data.taxon.visState.score.overall==n?"black":"taxon"==e.selectedRank?"black":null}).style("stroke-width",function(t){return n>0&&t.data.data.taxon.visState.score.overall==n?"2px":"taxon"==e.selectedRank?"1px":"0px"}).style("stroke-linecap",function(t){return n>0&&t.data.data.taxon.visState.score.overall==n?"round":null}).style("stroke-dasharray",function(t){return n>0&&t.data.data.taxon.visState.score.overall==n?"1, 5":null})}(M)},r.urlParams=function(t){t.abbrvnames&&(e.abbrvnames="true"===t.abbrvnames),t.rank&&(e.selectedRank=t.rank,E(e.selectedRank)),t.highertaxa&&(g=x),t.imgtips&&(e.displayToolTips="true"===t.imgtips),a.f.initControlsFromParams(t)},r.show=function(){t("#vis5").show(),t(r.inputControl.divSel).show(),r.inputControl.initFromCharacterState()},r.hide=function(){t("#vis5").hide(),t(r.inputControl.divSel).hide()}}(jQuery,this.tombiovis);